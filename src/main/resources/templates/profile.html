<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MyBank-Profile</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"><link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="stylesheet" th:href="@{/styles/styles.css}">
  <script th:src="@{'/js/dashboard.js'}"></script>
  <style>
    body {
      background-color: white;
      color: white;
    }
    .btn-primary {
      background-color: #182052;
      border-color: #182052;
      border-radius: 10px;
    }
    .btn-primary:hover {
      background-color: #f5854d;
      border-color: #f5854d;
    }
    .form-control {
      background-color: #ffffff;
      border-color: #182052;
      border-width: 1.5px; /* Adjust the value as needed */

    }
    .form-control::placeholder {
      color: grey;
      opacity: 0.5;
    }
    .form-group label {
      color: #182052;
      font-weight: bold;
    }
    .form-group input:hover{
      border-color: darkorange;
    }
    .form-group textarea:hover{
      border-color: darkorange;
    }
    .card {
      border: none;
    }
    .alert.fade {
      transition: opacity 1.5s linear;
    }
  </style>
</head>
<body>
<div th:replace="dashboard :: dashboard"></div>
<div class="container-fluid">
  <div class="row justify-content-between">
    <div class="col-auto">
          <a href="javascript:void(0)" onclick="window.history.back()" class="text-light mt-3 "><i class="bi bi-arrow-left-circle-fill btn btn-primary mt-3" style=" font-size: 24px;border-radius: 50px;padding: 3px"></i></a>
    </div>
  </div>
</div>

<div class="container">
  <div class="d-flex align-items-center mb-2">
    <i class="bi bi-person-circle" style="color: #182052; font-size: 55px;"></i>
    <h2 class="ml-3" style="color: #182052; font-size: 44px; font-weight: 700; font-family: 'Poppins', sans-serif;">My Profile</h2>
  </div>
  <div class="d-flex justify-content-center">
    <div class="card col col-9 ">
      <div class="card-body">
        <div id="email-alert" class="alert alert-danger d-none" role="alert">
        </div>
        <div id="phone-alert" class="alert alert-danger d-none" role="alert">
          <!-- Phone alert message will be dynamically set here -->
        </div>
        <form name = "application" th:action="@{'/account/update'}" method="post">
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="firstName">FIRST NAME:</label>
              <input type="text" class="form-control" th:value="${customer.firstName}" th:name="firstName" id="firstName" placeholder="Enter first name" required>
              <span id="firstNameErr" class="error"></span>
            </div>
            <div class="form-group col-md-1"></div>
            <div class="form-group col-md-1"></div>
            <div class="form-group col-md-5">
              <label for="username">USER NAME:</label>
              <div class="input-group">
                <input type="hidden" id="current-username" th:value="${customer.username}" />
                <input type="text" class="form-control"  th:value="${customer.username}" th:name="username" id="username" placeholder="Enter username" required oninput="checkUsername()">
                <span id="username-status-icon" class="input-group-text d-none"></span>
              </div>
              <span id="username-status-message" class="d-none"></span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="middleName">MIDDLE NAME:</label>
              <input type="text" class="form-control" th:value="${customer.middleName}" th:name="middleName" id="middleName" placeholder="Enter middle name" required>
              <span id="middleNameErr" class="error"></span>

            </div>
            <div class="form-group col-md-1"></div>
            <div class="form-group col-md-1"></div>

            <!-- Add a 'Change Password' button next to the password field -->
            <div class="form-group col-md-5">
              <label for="password">PASSWORD:</label>
              <div class="input-group">
                <input type="password" name="password" th:value="${customer.password}" th:name="password" class="form-control" id="password" readonly placeholder="Enter password" required>
                <span class="text-warning input-group-text btn btn-danger" id="change-password-span" style="cursor: pointer; font-weight: bolder;" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                  <i class="bi bi-shield-lock-fill"></i> Change Password
                </span>
              </div>
              <span id="passwordErr" class="error"></span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="lastName">LAST NAME:</label>
              <input type="text" class="form-control" th:value="${customer.lastName}" th:name="lastName" id="lastName" placeholder="Enter last name" required>
              <span id="KeyBenefitsErr" class="error"></span>

            </div>
            <div class="form-group col-md-1"></div>
            <div class="form-group col-md-1"></div>

            <div class="form-group col-md-5">
              <label for="email">EMAIL:</label>
              <div class="input-group">
                <input type="hidden" id="current-email" th:value="${customer.email}" />
                <input type="email" th:name="email" th:value="${customer.email}" class="form-control" id="email" placeholder="Enter email" required oninput="checkEmail()">
                <span id="email-status-icon" class="input-group-text d-none"></span>
              </div>
              <span id="email-status-message" class="d-none"></span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="birthDate">BIRTH DATE:</label>
              <input type="date" class="form-control" th:value="${customer.birthDate}" th:name="birthDate" id="birthDate" placeholder="DD/MM/YYYY" required>
              <span id="birthDateErr" class="error"></span>

            </div>
            <div class="form-group col-md-1"></div>
            <div class="form-group col-md-1"></div>

            <div class="form-group col-md-5">
              <label for="email">PHONE NUMBER:</label>
              <div class="input-group">
                <input type="hidden" id="current-phone" th:value="${customer.phoneNumber}" />
                <input type="number" maxlength="10" minlength="10" th:value="${customer.phoneNumber}" th:name="phoneNumber" class="form-control" id="phonenumber" placeholder="Enter phone number" required oninput="checkPhoneNumber()">
                <span id="phone-status-icon" class="input-group-text d-none"></span>
              </div>
              <span id="phone-status-message" class="d-none"></span>
            </div>
          </div><div class="form-row">
          <div class="form-group col-md-5">
            <label for="address">ADDRESS:</label>
            <textarea class="form-control" id="address" th:text="${customer.address}" th:name="address" rows="3" placeholder="Enter address." required></textarea>
            <span id="addressErr" class="error"></span>

          </div>
          <div class="form-group col-md-1"></div>
          <div class="form-group col-md-1"></div>
            <div class="form-group col-md-5">
              <label for="aadhaarNumber">AADHAAR NUMBER:</label>
              <input type="number" class="form-control" maxlength="12" minlength="12" th:value="${customer.aadhaarNumber}" th:name="aadhaarNumber" id="aadhaarNumber" placeholder="Enter aadhaar number." required>
              <span id="aadhaarNumberErr" class="error"></span>
            </div>
          </div>
          <br>
          <button id="add" type="submit" class="btn btn-primary">Update Profile</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap Modal for Changing Password -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bolder" style="color: #182052" id="changePasswordModalLabel">Create new password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updatePasswordForm">
          <div class="form-group">
            <label for="currentPassword">Current Password:</label>
            <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password" required>
          </div>
          <div class="form-group">
            <label for="newPassword">New Password:</label>
            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" required>
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password:</label>
            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password" required>
            <span id="passwordUpdateErr" class="error"></span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updatePassword()">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  var passwordField = document.getElementById("password");
  var confirmPasswordField = document.getElementById("confirmPassword");
  var errorMessage = document.getElementById("error-message");
  var passwordStrengthMessage = document.getElementById("password-strength-message");
  var isValidUsername, isValidEmail, isValidPhoneNumber, isValidPassword;

  // Function to check if username is available
  function checkUsername() {
    const currentUsername = $('#current-username').val(); // Get current logged-in username
    const username = $('#username').val(); // Get entered username
    const statusSpan = $('#username-status-message'); // Use jQuery for status message
    const statusIcon = $('#username-status-icon'); // Use jQuery for status icon

    if (username) {
      // Proceed only if entered username is not empty
      fetch(`/ui/check-username?username=${username}`)
              .then(response => response.json())
              .then(data => {
                if (data.exists) {
                  if (username === currentUsername) {
                    // Username matches the currently logged-in user
                    statusSpan.text('This is your current username');
                    statusSpan.removeClass().addClass('text-success'); // Add Bootstrap success class
                    statusIcon.html('<i class="bi bi-check-circle-fill text-success"></i>'); // Green check icon
                    isValidUsername = true;
                  } else {
                    // Username exists and is different from the current one
                    statusSpan.text('Username already taken');
                    statusSpan.removeClass().addClass('text-danger'); // Add Bootstrap danger class
                    statusIcon.html('<i class="bi bi-x-circle-fill text-danger"></i>'); // Red cross icon
                    isValidUsername = false;
                  }
                } else {
                  // Username does not exist
                  statusSpan.text('Username available');
                  statusSpan.removeClass().addClass('text-success'); // Add Bootstrap success class
                  statusIcon.html('<i class="bi bi-check-circle-fill text-success"></i>'); // Green check icon
                  isValidUsername = true;
                }
                statusSpan.removeClass('d-none'); // Show the message
                statusIcon.removeClass('d-none'); // Show the icon
              })
              .catch(error => {
                console.error('Error:', error);
                statusSpan.text('An error occurred');
                statusSpan.removeClass().addClass('text-danger'); // Add Bootstrap danger class
                statusIcon.html('<i class="bi bi-x-circle-fill text-danger"></i>'); // Red cross icon
                statusSpan.removeClass('d-none'); // Show the message
                statusIcon.removeClass('d-none');
                isValidUsername = false;
              });
    } else {
      // Hide the status message and icon if username is empty
      statusSpan.addClass('d-none');
      statusIcon.addClass('d-none');
    }
  }


  // Function to check if email is already in use
  function checkEmail() {
    const currentEmail = $('#current-email').val(); // Get current logged-in username
    const email = document.getElementById('email').value;
    const statusSpan = document.getElementById('email-status-message');
    const statusIcon = document.getElementById('email-status-icon');
    const emailAlert = document.getElementById('email-alert');

    if (email) {
      fetch(`/ui/check-email?email=${email}`)
              .then(response => response.json())
              .then(data => {
                console.log(data);
                if (data.exists) {
                  if (email === currentEmail) {
                    // Email matches the currently logged-in user
                    statusSpan.textContent = 'This is your current Email';
                    statusSpan.classList.remove('text-danger');
                    statusSpan.classList.add('text-warning'); // Add Bootstrap success class
                    statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>'; // Green check icon
                    isValidEmail = true;
                  } else {
                    // Email exists and is different from the current one
                    statusSpan.textContent = 'Email already Registered by other user';
                    statusSpan.classList.remove('text-success');
                    statusSpan.classList.add('text-danger'); // Add Bootstrap danger class
                    statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>'; // Red cross icon
                    isValidEmail = false;
                  }
                } else {
                  statusSpan.textContent = '';
                  statusSpan.classList.remove('text-danger');
                  statusSpan.classList.add('text-success'); // Add Bootstrap success class
                  statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>'; // Green check icon
                  isValidEmail = true;
                }
                statusSpan.classList.remove('d-none'); // Show the message
                statusIcon.classList.remove('d-none');
              })
              .catch(error => {
                console.error('Error:', error);
                statusSpan.textContent = 'An error occurred';
                statusSpan.classList.remove('text-success');
                statusSpan.classList.add('text-danger'); // Add Bootstrap danger class
                statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>'; // Red cross icon
                statusSpan.classList.remove('d-none'); // Show the message
                statusIcon.classList.remove('d-none'); // Show the icon
                isValidEmail = false;
              });
    } else {
      statusSpan.classList.add('d-none'); // Hide the message if email is empty
      statusIcon.classList.add('d-none'); // Hide the icon
      emailAlert.classList.add('d-none');
    }
  }

  // Function to check if phone number is already in use
  // Function to check if phone number is already in use
  function checkPhoneNumber() {
    const currentPhone = $('#current-phone').val();
    const phoneNumber = document.getElementById('phonenumber').value;
    const statusSpan = document.getElementById('phone-status-message');
    const statusIcon = document.getElementById('phone-status-icon');
    const phoneAlert = document.getElementById('phone-alert');

    if (phoneNumber) {
      fetch(`/ui/check-phonenumber?phoneNumber=${phoneNumber}`)
              .then(response => response.json())
              .then(data => {
                if (data.exists) {
                  if (phoneNumber === currentPhone) {
                    // Phone number matches the currently logged-in user
                    statusSpan.textContent = 'This is your current phone number';
                    statusSpan.classList.remove('text-danger', 'text-success');
                    statusSpan.classList.add('text-warning'); // Add Bootstrap info class
                    statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>'; // Green check icon
                    isValidPhoneNumber = true;
                  } else {
                    // Phone number exists and is different from the current one
                    statusSpan.textContent = 'Phone number already registered by other user';
                    statusSpan.classList.remove('text-info', 'text-success');
                    statusSpan.classList.add('text-danger'); // Add Bootstrap danger class
                    statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>'; // Red cross icon
                    isValidPhoneNumber = false;
                  }
                } else {
                  // Phone number is available
                  statusSpan.textContent = '';
                  statusSpan.classList.remove('text-danger', 'text-info');
                  statusSpan.classList.add('text-success'); // Add Bootstrap success class
                  statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>'; // Green check icon
                  isValidPhoneNumber = true;
                }
                statusSpan.classList.remove('d-none'); // Show the message
                statusIcon.classList.remove('d-none');
              })
              .catch(error => {
                console.error('Error:', error);
                statusSpan.textContent = 'An error occurred';
                statusSpan.className = 'text-danger'; // Add Bootstrap danger class
                statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>'; // Red cross icon
                statusSpan.classList.remove('d-none'); // Show the message
                statusIcon.classList.remove('d-none'); // Show the icon
                isValidPhoneNumber = false;
              });
    } else {
      statusSpan.classList.add('d-none'); // Hide the message if phone number is empty
      statusIcon.classList.add('d-none'); // Hide the icon
      phoneAlert.classList.add('d-none');
    }
  }

  async function validateForm() {
    await checkUsername(); // Wait for username check
    await checkEmail();    // Wait for email check
    await checkPhoneNumber(); // Wait for phone number check

    checkPasswordMatch();
    checkPasswordStrength();

    // Combine the validation results
    return isValidUsername && isValidEmail && isValidPhoneNumber;
     // Allow form submission if all checks pass
  }
</script>
</body>
</html>